package com.yxm.sso.util.service;

import java.util.Map;

import javax.servlet.http.HttpServletRequest;

import org.apache.http.HttpResponse;
import org.apache.http.HttpStatus;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.util.EntityUtils;

import com.alibaba.fastjson.JSON;
import com.xiaoleilu.hutool.util.ObjectUtil;
import com.yxm.sso.domain.Person;
import com.yxm.sso.domain.vo.PersonVo;
import com.yxm.sso.util.domain.ApiResult;

/**
 * <p>
 * 说明:跨域请求处理业务类
 * </p>
 * 
 * @author:姚旭民
 * @date:2017-7-11 上午10:14:14
 */
public class TokenServiceImpl {
	public static String URL_SERVER = "http://localhost/YxmSSO/test/httpClientVerify.action";

	public static String verification(HttpServletRequest request, String token) {
		try {
			String verifyUrl = URL_SERVER;
			HttpClient httpClient = new DefaultHttpClient();
			// serverName作为本应用标识
			HttpGet httpGet = new HttpGet(verifyUrl + "?token=" + token
					+ "&localId=" + request.getSession().getId());
			HttpResponse response = httpClient.execute(httpGet);
			int statusCode = response.getStatusLine().getStatusCode();

			if (statusCode == HttpStatus.SC_OK) {
				String result = EntityUtils.toString(response.getEntity(),
						"utf-8");
				// 解析接送数据
			}
		} catch (Exception e) {

		}

		return "";
	}

	/*
	 * <p>说明:通过token获取用户信息</p>
	 * 
	 * @author:姚旭民
	 * 
	 * @data:2017-8-6 下午4:07:41
	 */
	public static ApiResult getUserInfo(HttpServletRequest request, String token) {
		ApiResult result = new ApiResult();
		result.setCode(-1);
		result.setMsg("无效的token");
		try {
			Map<String, String> map = RedisServiceImpl.getCacheData(
					Person.class, token);
			if (ObjectUtil.isNotNull(map)) {// 如果在redis里面找到了数据
				result.setCode(200);
				result.setMsg("获取信息成功");
				PersonVo person = PersonVo.fromJson(JSON.toJSONString(map));// 转化成对象
				result.setData(person);
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		return result;
	}
}
